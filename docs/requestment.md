# ğŸ… Project Vibe: Secret Santa (Web Application) - Product Requirements Document (PRD)

## 1. é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäº Web çš„è½»é‡çº§â€œåœ£è¯èŠ‚äº’æ¢ç¤¼ç‰©â€è¾…åŠ©å·¥å…·ã€‚
**æ ¸å¿ƒç†å¿µ**ï¼šå»è´¦å·åŒ–ï¼ˆNo-Accountï¼‰ã€åŸºäºå‡­è¯ï¼ˆKey-basedï¼‰ã€éšç§ä¼˜å…ˆã€‚
**ç›®æ ‡ç”¨æˆ·**ï¼šç†Ÿäººç¤¾äº¤åœˆï¼ˆæœ‹å‹ã€åŒäº‹ã€ç¤¾ç¾¤ï¼‰ã€‚
**ä¸»è¦åŠŸèƒ½**ï¼šæˆ¿ä¸»åˆ›å»ºæ´»åŠ¨ã€ç©å®¶é€šè¿‡é‚€è¯·ç å¡«æŠ¥ä¿¡æ¯ã€ç³»ç»Ÿéšæœºç”Ÿæˆå¾ªç¯é€ç¤¼åå•ã€ç©å®¶æŸ¥çœ‹é€ç¤¼å¯¹è±¡ä¿¡æ¯ã€‚

## 2. æŠ€æœ¯æ ˆ (Tech Stack)

* **Frontend & Backend Framework**: Next.js (App Router)
* **Database**: PostgreSQL
* **ORM**: Prisma
* **Styling**: Tailwind CSS + shadcn/ui (æ¨èï¼Œæ˜“äºå¿«é€Ÿæ„å»ºç°ä»£ UI)
* **Deployment**: Vercel (æ¨è) / Docker
* **Encryption**: Node.js `crypto` module (ç”¨äºæ•æ„Ÿå­—æ®µåŠ å¯†å­˜å‚¨)

---

## 3. è§’è‰²ä¸æƒé™ (Roles & Permissions)

### 3.1 æˆ¿ä¸» (Host)

* **å‡­è¯**ï¼š`Admin Key` (æ´»åŠ¨åˆ›å»ºæ—¶ç”Ÿæˆï¼Œä¸å¯æ‰¾å›ï¼Œéœ€å¦¥å–„ä¿å­˜)ã€‚
* **æƒé™**ï¼š
  * åˆ›å»ºæ´»åŠ¨ï¼Œè®¾ç½®æˆªæ­¢æ—¶é—´ã€‚
  * æŸ¥çœ‹å‚ä¸è€…åˆ—è¡¨ï¼ˆä»…æ˜µç§°ã€ç¤¾äº¤è´¦å·ã€**å‚ä¸ Key**ï¼‰ã€‚
  * **æ•‘æ´åŠŸèƒ½**ï¼šæŸ¥çœ‹å¹¶å¤åˆ¶æŸä½ç”¨æˆ·çš„ `å‚ä¸ Key` å‘é€ç»™å¯¹æ–¹ï¼ˆç”¨äºæ‰¾å›ï¼‰ã€‚
  * å‰”é™¤ä¸ç¬¦åˆè¦æ±‚çš„å‚ä¸è€…ã€‚
  * è§¦å‘â€œå¼€å§‹æŠ½é€‰â€ï¼ˆä¸å¯é€†ï¼‰ã€‚
  * æŸ¥çœ‹äº’æ¢åå•ï¼ˆé»˜è®¤é˜²å‰§é€ï¼Œéœ€ä¸»åŠ¨æ­ç¤ºï¼‰ã€‚
  * å¼€å¯â€œå…¬å¼€é€ç¤¼äººâ€ï¼ˆå…è®¸ç©å®¶æŸ¥çœ‹è°é€ç»™è‡ªå·±ï¼‰ã€‚
  * é”€æ¯æ´»åŠ¨ï¼ˆç‰©ç†åˆ é™¤æ•°æ®ï¼‰ã€‚

### 3.2 å‚ä¸ç©å®¶ (Participant)

* **å‡­è¯**ï¼š`Invite Key` (å…¬å…±é‚€è¯·ç ï¼Œè¿›å…¥æ´»åŠ¨)ã€`Participant Key` (ä¸ªäººå”¯ä¸€å‡­è¯ï¼Œæ“ä½œåç»­æµç¨‹)ã€‚
* **æƒé™**ï¼š
  * ä½¿ç”¨ `Invite Key` å¡«å†™æŠ¥åè¡¨å•ã€‚
  * **æ´»åŠ¨çŠ¶æ€=OPEN**ï¼šä½¿ç”¨ `Participant Key` ä¿®æ”¹ä¸ªäººèµ„æ–™ã€‚
  * **æ´»åŠ¨çŠ¶æ€=MATCHED**ï¼šä½¿ç”¨ `Participant Key` æŸ¥çœ‹**é€ç¤¼ç›®æ ‡**çš„è¯¦ç»†ä¿¡æ¯ï¼ˆæ˜æ–‡ï¼‰ã€‚
  * **æ´»åŠ¨çŠ¶æ€=REVEALED**ï¼šä½¿ç”¨ `Participant Key` æŸ¥çœ‹**é€ç¤¼ç»™è‡ªå·±çš„äºº**çš„ä¿¡æ¯ã€‚

---

## 4. æ ¸å¿ƒä¸šåŠ¡æµç¨‹ä¸åŠŸèƒ½éœ€æ±‚

### 4.1 é˜¶æ®µä¸€ï¼šæ´»åŠ¨åˆ›å»º (Creation Phase)

* **è¾“å…¥**ï¼šæ´»åŠ¨æ ‡é¢˜ã€æè¿°ï¼ˆå¯é€‰ï¼‰ã€æˆªæ­¢æ—¶é—´ã€‚
* **è¾“å‡º**ï¼šå±•ç¤º `Admin Key` å’Œ `Invite Key`ã€‚
* **é€»è¾‘**ï¼š
  * Keys åº”ä½¿ç”¨é«˜ç†µå­—ç¬¦ä¸²ç”Ÿæˆï¼ˆå¦‚ CUID æˆ– UUIDï¼‰ã€‚
  * **å‰ç«¯æç¤º**ï¼šå¼ºçƒˆè­¦å‘Šæˆ¿ä¸»ä¿å­˜ Admin Keyã€‚

### 4.2 é˜¶æ®µäºŒï¼šç©å®¶æŠ¥å (Join Phase)

* **å…¥å£**ï¼šè¾“å…¥ `Invite Key`ã€‚
* **æ ¡éªŒ**ï¼šæ´»åŠ¨æ˜¯å¦å­˜åœ¨ï¼Ÿæ˜¯å¦å·²è¿‡æˆªæ­¢æ—¶é—´ï¼Ÿæ˜¯å¦å·²æŠ½é€‰ï¼Ÿ
* **è¡¨å•å­—æ®µ**ï¼š
  * **å…¬å¼€ä¿¡æ¯**ï¼šæ˜µç§°ï¼ˆåŒä¸€æ´»åŠ¨å†…å”¯ä¸€ï¼‰ã€ç¤¾äº¤è´¦å·ï¼ˆQQ/Discordç­‰ï¼‰ã€‚
  * **éšç§ä¿¡æ¯**ï¼ˆéœ€åŠ å¯†å­˜å‚¨ï¼‰ï¼šæ‰‹æœºå·ã€æ”¶è´§åœ°å€ã€å§“åã€‚
  * **å…¶ä»–**ï¼šç¥ç¦è¯­ï¼ˆç»™æ¥æ”¶è€…ï¼‰ã€æ„Ÿè°¢è¯­ï¼ˆç»™é€ç¤¼è€…-å¯é€‰ï¼‰ã€‚
* **æäº¤å**ï¼šç”Ÿæˆå¹¶å±•ç¤º `Participant Key`ã€‚
  * **å‰ç«¯æç¤º**ï¼šå¼ºçƒˆå»ºè®®æˆªå›¾ä¿å­˜ï¼Œå¹¶å‘ŠçŸ¥è‹¥ä¸¢å¤±å¯æ‰¾æˆ¿ä¸»ã€‚

### 4.3 é˜¶æ®µä¸‰ï¼šæ´»åŠ¨ç®¡ç† (Management Phase)

* **å…¥å£**ï¼šè¾“å…¥ `Admin Key`ã€‚
* **åŠŸèƒ½**ï¼š
  * åˆ—è¡¨å±•ç¤ºï¼šæ˜µç§° | ç¤¾äº¤è´¦å· | çŠ¶æ€ | æ“ä½œã€‚
  * æ“ä½œåŒ…æ‹¬ï¼šåˆ é™¤ç”¨æˆ·ã€**æŸ¥çœ‹Key**ï¼ˆç‚¹å‡»æ˜¾ç¤ºè¯¥ç”¨æˆ·çš„ Participant Keyï¼‰ã€‚
  * ä¿®æ”¹æˆªæ­¢æ—¶é—´ï¼ˆä»…åœ¨ OPEN çŠ¶æ€ä¸‹ï¼‰ã€‚

### 4.4 é˜¶æ®µå››ï¼šæŠ½é€‰åŒ¹é… (Matching Phase)

* **è§¦å‘æ¡ä»¶**ï¼šæˆ¿ä¸»ç‚¹å‡»â€œå¼€å§‹æŠ½é€‰â€ && å½“å‰æ—¶é—´ > æˆªæ­¢æ—¶é—´ï¼ˆå¯é€‰å¼ºåˆ¶æ‰§è¡Œï¼‰ && äººæ•° >= 2ã€‚
* **ç®—æ³•é€»è¾‘**ï¼š
    1. è·å–æ‰€æœ‰å‚ä¸è€… ID åˆ—è¡¨ã€‚
    2. Fisher-Yates Shuffle æ‰“ä¹±åˆ—è¡¨ã€‚
    3. æ„å»ºå¾ªç¯é“¾è¡¨ï¼š`List[i].target = List[i+1]`ï¼Œ`List[Last].target = List[0]`ã€‚
    4. æ•°æ®åº“äº‹åŠ¡æ›´æ–°ï¼šå†™å…¥ `targetId`ï¼Œå°†æ´»åŠ¨çŠ¶æ€æ›´æ–°ä¸º `MATCHED`ã€‚
* **çº¦æŸ**ï¼šä¸€æ—¦æ‰§è¡Œï¼Œæ´»åŠ¨çŠ¶æ€é”å®šï¼Œä¸å¯æ–°å¢äººå‘˜ï¼Œä¸å¯ä¿®æ”¹ä¸ªäººä¿¡æ¯ã€‚

### 4.5 é˜¶æ®µäº”ï¼šç»“æœæŸ¥è¯¢ (Result Phase)

* **ç©å®¶è§†å›¾**ï¼š
  * è¾“å…¥ `Participant Key`ã€‚
  * **API å“åº”**ï¼šè§£å¯†è¿”å› `target` ç”¨æˆ·çš„å§“åã€åœ°å€ã€ç”µè¯ã€ç¤¾äº¤è´¦å·ã€ç¥ç¦è¯­ã€‚
  * **é»˜è®¤**ï¼šä¸è¿”å› `sender`ï¼ˆé€ç¤¼è€…ï¼‰ä¿¡æ¯ã€‚
* **æˆ¿ä¸»è§†å›¾**ï¼š
  * å±•ç¤ºåŒ¹é…åˆ—è¡¨ï¼š`A -> B`, `B -> C`ã€‚
  * **é˜²å‰§é€è®¾è®¡**ï¼šé»˜è®¤éšè—â€œè°é€ç»™æˆ¿ä¸»ï¼ˆå½“å‰Adminï¼‰â€çš„æ¡ç›®ï¼Œæˆ–é»˜è®¤æŠ˜å æ‰€æœ‰å…³ç³»ï¼Œç‚¹å‡»â€œæ˜¾ç¤ºå…¨éƒ¨â€æ‰æ¸²æŸ“ã€‚

### 4.6 é˜¶æ®µå…­ï¼šåç»­æ“ä½œ (Post-Event)

* **å…¬å¼€é€ç¤¼äºº**ï¼šæˆ¿ä¸»åˆ‡æ¢å¼€å…³ -> æ´»åŠ¨çŠ¶æ€ `REVEALED` -> ç©å®¶æ¥å£å¯è¿”å› `sender` ä¿¡æ¯ã€‚
* **æ•°æ®é”€æ¯**ï¼šæˆ¿ä¸»ç‚¹å‡»â€œç»“æŸæ´»åŠ¨â€æˆ–å®šæ—¶ä»»åŠ¡ -> ç‰©ç†åˆ é™¤ Activity åŠå…³è” Participants çš„æ•æ„Ÿå­—æ®µã€‚

---

## 5. æ•°æ®åº“è®¾è®¡ (Schema Design)

```prisma
// schema.prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum ActivityStatus {
  OPEN      // æŠ¥åä¸­
  MATCHED   // å·²æŠ½é€‰ï¼ŒæŸ¥çœ‹Target
  REVEALED  // å·²æ­æ™“ï¼ŒæŸ¥çœ‹Sender
}

model Activity {
  id          String   @id @default(cuid()) // å¯¹åº” Invite Key
  adminKey    String   @unique @default(cuid()) // ç®¡ç† Key
  name        String
  description String?
  status      ActivityStatus @default(OPEN)
  deadline    DateTime
  createdAt   DateTime @default(now())
  
  participants Participant[]
}

model Participant {
  id           String   @id @default(cuid()) // å¯¹åº” Participant Key
  activityId   String
  nickname     String   // æ˜µç§°
  
  // --- æ•æ„Ÿä¿¡æ¯ (å­˜å…¥æ•°æ®åº“å‰éœ€åº”ç”¨å±‚åŠ å¯†) ---
  realName     String   // çœŸå®å§“å (åŠ å¯†)
  socialAccount String  // ç¤¾äº¤è´¦å· (å¯ä¸åŠ å¯†ï¼Œä¾¿äºæˆ¿ä¸»ç¡®è®¤èº«ä»½)
  phone        String   // æ‰‹æœºå· (åŠ å¯†)
  address      String   // åœ°å€ (åŠ å¯†)
  // ---------------------------------------

  wishes       String   // ç»™Targetçš„ç¥ç¦
  thanks       String?  // ç»™Senderçš„æ„Ÿè°¢(å¯é€‰)

  // å…³ç³»æ˜ å°„
  targetId     String?  @unique // æˆ‘è¦é€ç»™è° (Self-relation ID)
  target       Participant? @relation("GiftCircle", fields: [targetId], references: [id])
  
  sender       Participant? @relation("GiftCircle") // è°é€ç»™æˆ‘

  activity     Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@unique([activityId, nickname]) // ä¿è¯åŒæˆ¿é—´å†…æ˜µç§°å”¯ä¸€
}
```

---

## 6. å®‰å…¨ä¸éšç§è§„èŒƒ (Security Specifications)

1. **æ•æ„Ÿæ•°æ®åŠ å¯† (Encryption at Rest)**:
    * **å­—æ®µ**ï¼š`realName`, `phone`, `address` å¿…é¡»åœ¨å†™å…¥æ•°æ®åº“å‰åŠ å¯†ã€‚
    * **æ–¹æ¡ˆ**ï¼šä½¿ç”¨ AES-256-GCM æˆ–ç±»ä¼¼å¯¹ç§°åŠ å¯†ç®—æ³•ã€‚
    * **å¯†é’¥ç®¡ç†**ï¼šå¯†é’¥ (Secret) å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡ `ENCRYPTION_KEY` ä¸­ï¼Œä¸å…¥åº“ã€‚
2. **API è®¿é—®æ§åˆ¶**:
    * æŸ¥è¯¢ `target` ä¿¡æ¯æ¥å£ï¼šå¿…é¡»æ ¡éªŒ `Participant Key` æœ‰æ•ˆæ€§ + `Activity.status != OPEN`ã€‚
    * æŸ¥è¯¢ `sender` ä¿¡æ¯æ¥å£ï¼šå¿…é¡»æ ¡éªŒ `Participant Key` æœ‰æ•ˆæ€§ + `Activity.status == REVEALED`ã€‚
3. **é˜²æ’åº“/çˆ†ç ´**:
    * é’ˆå¯¹ Key çš„æŸ¥è¯¢æ¥å£å¢åŠ  Rate Limiting (å¦‚æ¯IPæ¯åˆ†é’Ÿé™åˆ¶ 10 æ¬¡è¯·æ±‚)ã€‚
4. **æ•°æ®è„±æ•**:
    * æˆ¿ä¸» APIï¼šå³ä¾¿æ˜¯æˆ¿ä¸»ï¼Œè°ƒç”¨è·å–å‚ä¸è€…åˆ—è¡¨æ¥å£æ—¶ï¼Œåç«¯ä¹Ÿä¸¥ç¦è¿”å›è§£å¯†åçš„åœ°å€å’Œç”µè¯ï¼Œåªè¿”å›æ˜µç§°å’Œç¤¾äº¤è´¦å·ã€‚

---

## 7. UI/UX å»ºè®® (UI Guidelines)

* **é£æ ¼ (Vibe)**:
  * èŠ‚æ—¥æ°›å›´ï¼šåœ£è¯çº¢ (#D42426)ã€æ¾æ ‘ç»¿ (#165B33)ã€é›ªç™½ã€é‡‘è‰²ç‚¹ç¼€ã€‚
  * äº¤äº’ï¼šå¡ç‰‡å¼è®¾è®¡ï¼Œæ‹Ÿç‰©åŒ–ä¿¡å°å¼€å¯åŠ¨æ•ˆï¼ˆæŸ¥çœ‹ç»“æœæ—¶ï¼‰ã€‚
* **ç§»åŠ¨ç«¯ä¼˜å…ˆ**: ç»å¤§å¤šæ•°ç”¨æˆ·ä¼šåœ¨å¾®ä¿¡/Discordå†…ç½®æµè§ˆå™¨æ‰“å¼€ï¼Œç¡®ä¿å“åº”å¼å¸ƒå±€å®Œç¾ã€‚
* **å®¹é”™è®¾è®¡**:
  * Key çš„è¾“å…¥æ¡†æ”¯æŒâ€œä¸€é”®ç²˜è´´â€ã€‚
  * Key çš„å±•ç¤ºé¡µé¢æ”¯æŒâ€œä¸€é”®å¤åˆ¶â€ã€‚
  * é•¿æ–‡æœ¬ï¼ˆå¦‚åœ°å€ï¼‰è¾“å…¥æ¡†æ”¯æŒå¤šè¡Œã€‚

---

## 8. å¼€å‘è·¯çº¿å›¾ (Roadmap for AI Vibe Coding)

1. **Step 1: Scaffolding**: åˆå§‹åŒ– Next.js + Prismaï¼Œé…ç½®æ•°æ®åº“è¿æ¥ã€‚
2. **Step 2: Core Models**: å®šä¹‰ Prisma Schema å¹¶è¿ç§»æ•°æ®åº“ã€‚
3. **Step 3: Encryption Utils**: ç¼–å†™ AES åŠ è§£å¯†å·¥å…·å‡½æ•°ã€‚
4. **Step 4: Host Actions**: å®ç°åˆ›å»ºæ´»åŠ¨ã€ç®¡ç†åå° APIã€‚
5. **Step 5: Player Join**: å®ç°æŠ¥åè¡¨å•ã€Key ç”Ÿæˆé€»è¾‘ã€‚
6. **Step 6: Matching Logic**: å®ç°æ´—ç‰Œç®—æ³•å’Œæ•°æ®åº“äº‹åŠ¡æ›´æ–°ã€‚
7. **Step 7: Reveal Interface**: å®ç°ç©å®¶æŸ¥çœ‹ç»“æœçš„è§£å¯† API å’Œå‰ç«¯é¡µé¢ã€‚
8. **Step 8: Polish**: å¢åŠ  UI åŠ¨æ•ˆã€é˜²å‰§é€å¼€å…³ã€æ•°æ®æ¸…ç† Jobã€‚
